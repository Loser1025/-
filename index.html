<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本人確認書類 理解度テスト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .answer-btn-correct {
             background-color: #ecfdf5;
             border-color: #10b981;
             color: #065f46;
        }
        .answer-btn-incorrect {
            background-color: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-indigo-100 flex items-start justify-center min-h-screen py-16 px-4">
    <div id="app-container" class="bg-white/80 backdrop-blur-xl p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-2xl ring-1 ring-black/5">
        
        <!-- Loading Area -->
        <div id="loading-area" class="text-center py-12">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-slate-600 animate-pulse">テストを準備しています...</p>
        </div>

        <!-- Start Area -->
        <div id="start-area" class="text-center hidden fade-in">
             <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>
            </div>
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 mt-4">本人確認書類 理解度テスト</h1>
            <p class="mt-2 text-slate-600">あなたの名前を選択して、テストを開始してください。</p>
            <div class="mt-8">
                <select id="name-select" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white shadow-sm">
                    <option value="">名前を選択してください</option>
                </select>
                <p id="name-error" class="text-red-500 text-sm mt-2 hidden">名前を選択してください。</p>
            </div>
            <button id="start-button" class="mt-6 w-full bg-gradient-to-r from-indigo-600 to-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:shadow-lg hover:from-indigo-700 transition-all duration-300 transform hover:scale-105">テストを開始</button>
        </div>

        <!-- Quiz Area -->
        <div id="quiz-container" class="hidden">
            <div id="quiz-header" class="mb-6">
                <div class="text-sm text-slate-500 flex justify-between items-center">
                    <span id="question-counter" class="font-medium"></span>
                    <span id="score-counter" class="font-bold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full">スコア: 0</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2.5 mt-3">
                    <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-blue-400 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div id="question-area" class="fade-in">
                <h2 id="question-text" class="text-xl font-bold text-slate-800 mb-6 min-h-[56px]"></h2>
                <div id="answer-options" class="grid grid-cols-1 gap-3"></div>
                <p id="hint-text" class="mt-5 text-sm text-slate-600 bg-slate-100 p-3 rounded-lg hidden"></p>
            </div>
            <div id="feedback-area" class="mt-6 hidden fade-in">
                <div id="feedback-content" class="p-4 rounded-lg text-sm">
                    <p id="feedback-text" class="text-base"></p>
                </div>
                <button id="next-button" class="mt-4 w-full bg-gradient-to-r from-indigo-600 to-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:shadow-lg hover:from-indigo-700 transition-all duration-300 transform hover:scale-105">次の問題へ</button>
            </div>
        </div>

        <!-- Results Area -->
        <div id="results-area" class="text-center hidden fade-in">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mt-4">テスト完了！</h2>
            <p id="results-for-name" class="mt-1 text-slate-600"></p>
            <p class="mt-4 text-lg text-slate-600">あなたのスコア</p>
            <p id="final-score" class="text-6xl font-extrabold my-2"></p>
            <p id="score-message" class="text-slate-700 font-medium text-lg"></p>
            <p id="submission-status" class="text-sm text-slate-500 mt-6 h-5"></p>
            <button id="restart-button" class="mt-4 w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 transition-colors duration-300">もう一度挑戦する</button>
        </div>

        <!-- Error Area -->
        <div id="error-area" class="text-center hidden fade-in">
            <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h2 class="text-xl font-bold text-red-600 mt-4">エラーが発生しました</h2>
            <p id="error-message" class="mt-4 text-slate-700 bg-red-50 p-4 rounded-lg ring-1 ring-red-200"></p>
        </div>
    </div>

<script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwCF0PQQlf0QrqtFgOgu-SPpRmy3KV8u6Ikbz4Wm-sJoRFP1G4d7yWhkG1zSyJT3Hhqqg/exec';

    let quizData = [];
    let userAnswers = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let responderName = '';
    
    const elements = {
        loadingArea: document.getElementById('loading-area'),
        startArea: document.getElementById('start-area'),
        nameSelect: document.getElementById('name-select'),
        nameError: document.getElementById('name-error'),
        startButton: document.getElementById('start-button'),
        quizContainer: document.getElementById('quiz-container'),
        resultsArea: document.getElementById('results-area'),
        errorArea: document.getElementById('error-area'),
        errorMessage: document.getElementById('error-message'),
        questionArea: document.getElementById('question-area'),
        questionCounter: document.getElementById('question-counter'),
        scoreCounter: document.getElementById('score-counter'),
        progressBar: document.getElementById('progress-bar'),
        questionText: document.getElementById('question-text'),
        answerOptions: document.getElementById('answer-options'),
        hintText: document.getElementById('hint-text'),
        feedbackArea: document.getElementById('feedback-area'),
        feedbackContent: document.getElementById('feedback-content'),
        feedbackText: document.getElementById('feedback-text'),
        nextButton: document.getElementById('next-button'),
        resultsForName: document.getElementById('results-for-name'),
        finalScore: document.getElementById('final-score'),
        scoreMessage: document.getElementById('score-message'),
        submissionStatus: document.getElementById('submission-status'),
        restartButton: document.getElementById('restart-button'),
    };
    
    async function fetchData() {
        if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.length < 20) {
            showError("ウェブアプリのURLが設定されていません。HTMLファイルを編集してください。");
            return;
        }
        try {
            const [namesRes, quizRes] = await Promise.all([
                fetch(`${APPS_SCRIPT_URL}?action=getNames`),
                fetch(`${APPS_SCRIPT_URL}?action=getQuiz`)
            ]);
            if (!namesRes.ok || !quizRes.ok) throw new Error(`サーバーとの通信に失敗しました。(status: ${namesRes.status}, ${quizRes.status})`);
            const namesData = await namesRes.json();
            if (namesData.result !== 'success') throw new Error(namesData.message);
            populateNameSelector(namesData.names);
            
            const quizPayload = await quizRes.json();
            if (quizPayload.result !== 'success') throw new Error(quizPayload.message);
            quizData = quizPayload.questions.map(q => ({
                ...q,
                options: shuffleArray([...q.options])
            }));
            
            if (quizData.length === 0) {
                showError("スプレッドシートにクイズの問題が登録されていません。");
                return;
            }
            elements.loadingArea.classList.add('hidden');
            elements.startArea.classList.remove('hidden');
        } catch (error) {
            showError(`データの読み込みに失敗しました: ${error.message} スプレッドシートの共有設定やスクリプトのデプロイ設定をご確認ください。`);
        }
    }

    function populateNameSelector(names) {
        const nameSelect = elements.nameSelect;
        nameSelect.innerHTML = '<option value="">名前を選択してください</option>';
        names.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            nameSelect.appendChild(option);
        });
    }
    
    function submitResults(name, scorePercentage, answers) {
        elements.submissionStatus.textContent = '結果を記録中...';
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ name, score: scorePercentage, answers: answers }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        })
        .then(() => {
            elements.submissionStatus.innerHTML = `
                <span class="flex items-center justify-center text-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                    結果が記録されました
                </span>`;
        })
        .catch(error => {
            elements.submissionStatus.textContent = 'エラー：結果を記録できませんでした。';
        });
    }

    function startQuiz() {
        responderName = elements.nameSelect.value;
        if (!responderName) {
            elements.nameError.classList.remove('hidden');
            return;
        }
        elements.nameError.classList.add('hidden');
        elements.startArea.classList.add('hidden');
        elements.quizContainer.classList.remove('hidden');
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = []; // 回答履歴をリセット
        showQuestion();
        updateScore();
    }
    
    function showQuestion() {
        elements.questionArea.classList.remove('fade-in');
        void elements.questionArea.offsetWidth; // Trigger reflow
        elements.questionArea.classList.add('fade-in');

        const question = quizData[currentQuestionIndex];
        elements.questionCounter.textContent = `問題 ${currentQuestionIndex + 1} / ${quizData.length}`;
        elements.progressBar.style.width = `${((currentQuestionIndex) / quizData.length) * 100}%`;
        elements.questionText.textContent = question.question;
        
        elements.answerOptions.innerHTML = '';
        question.options.forEach(option => {
            const button = document.createElement('button');
            button.innerHTML = `<span>${option.text}</span>`;
            button.className = 'w-full text-left p-4 border border-slate-300 rounded-lg hover:bg-slate-50 hover:border-indigo-400 transition-all duration-200 transform hover:-translate-y-1 shadow-sm flex justify-between items-center';
            button.onclick = () => selectAnswer(button, option);
            elements.answerOptions.appendChild(button);
        });
        elements.hintText.textContent = `ヒント: ${question.hint}`;
        elements.hintText.classList.remove('hidden');
        elements.feedbackArea.classList.add('hidden');
    }

    function selectAnswer(button, selectedOption) {
        userAnswers[currentQuestionIndex] = selectedOption.text; // 回答を記録
        elements.hintText.classList.add('hidden');
        Array.from(elements.answerOptions.children).forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
             btn.classList.remove('hover:-translate-y-1');
        });
        
        if (selectedOption.correct) {
            score++;
            button.classList.add('answer-btn-correct');
            button.innerHTML += `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
            elements.feedbackContent.className = 'p-4 rounded-lg bg-green-100 text-green-800';
            elements.feedbackText.innerHTML = `<strong class="font-bold">正解！</strong><br>${selectedOption.rationale || ''}`;
        } else {
            button.classList.add('answer-btn-incorrect');
            button.innerHTML += `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
            elements.feedbackContent.className = 'p-4 rounded-lg bg-red-100 text-red-800';
            const correctOption = quizData[currentQuestionIndex].options.find(opt => opt.correct);
            elements.feedbackText.innerHTML = `<strong class="font-bold">不正解...</strong><br>${selectedOption.rationale || ''}<br><br><strong class="font-semibold">正解は:</strong> ${correctOption.text}`;
            Array.from(elements.answerOptions.children).forEach((btn, index) => {
                if (quizData[currentQuestionIndex].options[index].correct) {
                    btn.classList.add('answer-btn-correct');
                }
            });
        }
        
        updateScore();
        elements.feedbackArea.classList.remove('hidden');
        elements.nextButton.textContent = (currentQuestionIndex === quizData.length - 1) ? '結果を見る' : '次の問題へ';
    }

    function updateScore() {
        elements.scoreCounter.textContent = `スコア: ${score}`;
    }

    function showResults() {
        elements.quizContainer.classList.add('hidden');
        elements.resultsArea.classList.remove('hidden');
        
        const percentage = quizData.length > 0 ? Math.round((score / quizData.length) * 100) : 0;
        elements.resultsForName.textContent = `${responderName}さんの結果`;
        elements.finalScore.textContent = `${percentage}%`;
        
        let message = '';
        if (percentage === 100) {
            message = '素晴らしい！完璧です！';
            elements.finalScore.className = 'text-6xl font-extrabold text-green-500 my-2';
        } else if (percentage >= 80) {
            message = '優秀です！';
            elements.finalScore.className = 'text-6xl font-extrabold text-indigo-500 my-2';
        } else {
            message = 'もう一度復習してみましょう！';
            elements.finalScore.className = 'text-6xl font-extrabold text-amber-500 my-2';
        }
        elements.scoreMessage.textContent = message;
        submitResults(responderName, percentage, userAnswers);
    }
    
    function restartQuiz() {
        elements.resultsArea.classList.add('hidden');
        elements.loadingArea.classList.remove('hidden');
        elements.nameSelect.value = '';
        fetchData();
    }

    function showError(message) {
        elements.loadingArea.classList.add('hidden');
        elements.startArea.classList.add('hidden');
        elements.quizContainer.classList.add('hidden');
        elements.errorMessage.textContent = message;
        elements.errorArea.classList.remove('hidden');
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- Event Listeners ---
    elements.startButton.addEventListener('click', startQuiz);
    elements.nextButton.addEventListener('click', () => {
        currentQuestionIndex++;
        if (currentQuestionIndex < quizData.length) {
            showQuestion();
        } else {
            showResults();
        }
    });
    elements.restartButton.addEventListener('click', restartQuiz);
    
    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', fetchData);
</script>
</body>
</html>


