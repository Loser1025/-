<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本人確認書類 理解度テスト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8">
    <div id="app-container" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg w-full max-w-2xl mx-4">
        
        <!-- Loading Area -->
        <div id="loading-area" class="text-center">
             <div class="loader mx-auto"></div>
             <p class="mt-4 text-gray-600">クイズを準備しています...</p>
        </div>

        <!-- Start Area -->
        <div id="start-area" class="text-center hidden">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">本人確認書類 理解度テスト</h1>
            <p class="mt-4 text-gray-600">あなたの名前を選択して、テストを開始してください。</p>
            <div class="mt-6">
                <select id="name-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="">名前を選択してください</option>
                </select>
                <p id="name-error" class="text-red-500 text-sm mt-2 hidden">名前を選択してください。</p>
            </div>
            <button id="start-button" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">テストを開始</button>
        </div>

        <!-- Quiz Area -->
        <div id="quiz-container" class="hidden">
            <div id="quiz-header" class="mb-6">
                <div class="mt-2 text-sm text-gray-500 flex justify-between">
                    <span id="question-counter"></span>
                    <span id="score-counter">スコア: 0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div id="question-area">
                <h2 id="question-text" class="text-xl font-semibold text-gray-700 mb-5 min-h-[60px]"></h2>
                <div id="answer-options" class="grid grid-cols-1 gap-3"></div>
                <p id="hint-text" class="mt-4 text-sm text-gray-500 bg-gray-50 p-3 rounded-lg hidden"></p>
            </div>
            <div id="feedback-area" class="mt-5 hidden">
                <div id="feedback-content" class="p-4 rounded-lg">
                    <p id="feedback-text" class="text-base"></p>
                </div>
                <button id="next-button" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">次の問題へ</button>
            </div>
        </div>

        <!-- Results Area -->
        <div id="results-area" class="text-center hidden">
            <h2 class="text-2xl font-bold text-gray-800">クイズ完了！</h2>
            <p id="results-for-name" class="mt-2 text-gray-600"></p>
            <p class="mt-3 text-lg text-gray-600">あなたのスコア</p>
            <p id="final-score" class="text-5xl font-extrabold text-blue-600 my-4"></p>
            <p id="score-message" class="text-gray-700 font-medium"></p>
             <p id="submission-status" class="text-sm text-gray-500 mt-4"></p>
            <button id="restart-button" class="mt-8 w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors">もう一度挑戦する</button>
        </div>

        <!-- Error Area -->
        <div id="error-area" class="text-center hidden">
            <h2 class="text-xl font-bold text-red-600">エラーが発生しました</h2>
            <p id="error-message" class="mt-4 text-gray-700 bg-red-50 p-4 rounded-lg"></p>
        </div>
    </div>

<script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwfLRwuMM6Pzk-agwGwU-JSW20OKDkI4BOLLZC-drhLLeVXKOCt9eQ1QAyVXSkD0jr/exec'; // ← ここにデプロイしたウェブアプリのURLを貼り付けます

    let quizData = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let responderName = '';
    
    const elements = {
        loadingArea: document.getElementById('loading-area'),
        startArea: document.getElementById('start-area'),
        nameSelect: document.getElementById('name-select'),
        nameError: document.getElementById('name-error'),
        startButton: document.getElementById('start-button'),
        quizContainer: document.getElementById('quiz-container'),
        resultsArea: document.getElementById('results-area'),
        errorArea: document.getElementById('error-area'),
        errorMessage: document.getElementById('error-message'),
        questionCounter: document.getElementById('question-counter'),
        scoreCounter: document.getElementById('score-counter'),
        progressBar: document.getElementById('progress-bar'),
        questionText: document.getElementById('question-text'),
        answerOptions: document.getElementById('answer-options'),
        hintText: document.getElementById('hint-text'),
        feedbackArea: document.getElementById('feedback-area'),
        feedbackContent: document.getElementById('feedback-content'),
        feedbackText: document.getElementById('feedback-text'),
        nextButton: document.getElementById('next-button'),
        resultsForName: document.getElementById('results-for-name'),
        finalScore: document.getElementById('final-score'),
        scoreMessage: document.getElementById('score-message'),
        submissionStatus: document.getElementById('submission-status'),
        restartButton: document.getElementById('restart-button'),
    };
    
    async function fetchData() {
        if (!APPS_SCRIPT_URL) {
            showError("ウェブアプリのURLが設定されていません。HTMLファイルを編集してください。");
            return;
        }

        try {
            const [namesRes, quizRes] = await Promise.all([
                fetch(`${APPS_SCRIPT_URL}?action=getNames`),
                fetch(`${APPS_SCRIPT_URL}?action=getQuiz`)
            ]);

            const namesData = await namesRes.json();
            if (namesData.result !== 'success') throw new Error(namesData.message);
            populateNameSelector(namesData.names);
            
            const quizPayload = await quizRes.json();
            if (quizPayload.result !== 'success') throw new Error(quizPayload.message);
            quizData = quizPayload.questions;
            
            if (quizData.length === 0) {
                showError("スプレッドシートにクイズの問題が登録されていません。");
                return;
            }

            elements.loadingArea.classList.add('hidden');
            elements.startArea.classList.remove('hidden');

        } catch (error) {
            showError(`データの読み込みに失敗しました: ${error.message}`);
        }
    }

    function populateNameSelector(names) {
        const nameSelect = elements.nameSelect;
        nameSelect.innerHTML = '<option value="">名前を選択してください</option>';
        names.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            nameSelect.appendChild(option);
        });
    }
    
    function submitResults(name, scorePercentage) {
        elements.submissionStatus.textContent = '結果を記録中...';
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ name, score: scorePercentage }),
            headers: { 'Content-Type': 'application/json' },
        })
        .then(() => {
            elements.submissionStatus.textContent = '結果が記録されました。';
        })
        .catch(error => {
            elements.submissionStatus.textContent = 'エラー：結果を記録できませんでした。';
        });
    }

    function startQuiz() {
        responderName = elements.nameSelect.value;
        if (!responderName) {
            elements.nameError.classList.remove('hidden');
            return;
        }
        elements.nameError.classList.add('hidden');

        elements.startArea.classList.add('hidden');
        elements.quizContainer.classList.remove('hidden');

        currentQuestionIndex = 0;
        score = 0;
        showQuestion();
        updateScore();
    }
    
    function showQuestion() {
        const question = quizData[currentQuestionIndex];
        elements.questionCounter.textContent = `問題 ${currentQuestionIndex + 1} / ${quizData.length}`;
        elements.progressBar.style.width = `${((currentQuestionIndex) / quizData.length) * 100}%`;
        elements.questionText.textContent = question.question;
        
        elements.answerOptions.innerHTML = '';
        question.options.forEach(option => {
            const button = document.createElement('button');
            button.textContent = option.text;
            button.className = 'w-full text-left p-4 border rounded-lg hover:bg-gray-50 transition-colors';
            button.onclick = () => selectAnswer(button, option);
            elements.answerOptions.appendChild(button);
        });

        elements.hintText.textContent = `ヒント: ${question.hint}`;
        elements.hintText.classList.remove('hidden');
        elements.feedbackArea.classList.add('hidden');
    }

    function selectAnswer(button, selectedOption) {
        elements.hintText.classList.add('hidden');
        Array.from(elements.answerOptions.children).forEach(btn => {
            btn.disabled = true;
        });
        
        if (selectedOption.correct) {
            score++;
            button.className += ' bg-green-100 border-green-500';
            elements.feedbackContent.className = 'p-4 rounded-lg bg-green-100';
            elements.feedbackText.innerHTML = `<strong class="text-green-800">正解！</strong><br>${selectedOption.rationale || ''}`;
        } else {
            button.className += ' bg-red-100 border-red-500';
            elements.feedbackContent.className = 'p-4 rounded-lg bg-red-100';
            const correctOption = quizData[currentQuestionIndex].options.find(opt => opt.correct);
            elements.feedbackText.innerHTML = `<strong class="text-red-800">不正解...</strong><br>${selectedOption.rationale || ''}<br><br><strong class="font-semibold">正解は:</strong> ${correctOption.text}`;
            Array.from(elements.answerOptions.children).forEach((btn, index) => {
                if (quizData[currentQuestionIndex].options[index].correct) {
                    btn.className += ' bg-green-100 border-green-500';
                }
            });
        }
        
        updateScore();
        elements.feedbackArea.classList.remove('hidden');
        elements.nextButton.textContent = (currentQuestionIndex === quizData.length - 1) ? '結果を見る' : '次の問題へ';
    }

    function updateScore() {
        elements.scoreCounter.textContent = `スコア: ${score}`;
    }

    function showResults() {
        elements.quizContainer.classList.add('hidden');
        elements.resultsArea.classList.remove('hidden');
        
        const percentage = Math.round((score / quizData.length) * 100);
        elements.resultsForName.textContent = `${responderName}さんの結果`;
        elements.finalScore.textContent = `${percentage}%`;
        
        let message = '';
        if (percentage === 100) {
            message = '素晴らしい！完璧です！';
            elements.finalScore.className = 'text-5xl font-extrabold text-green-600 my-4';
        } else if (percentage >= 80) {
            message = '優秀です！';
            elements.finalScore.className = 'text-5xl font-extrabold text-yellow-500 my-4';
        } else {
            message = 'もう一度復習してみましょう！';
            elements.finalScore.className = 'text-5xl font-extrabold text-red-600 my-4';
        }
        elements.scoreMessage.textContent = message;
        submitResults(responderName, percentage);
    }
    
    function restartQuiz() {
        elements.resultsArea.classList.add('hidden');
        elements.startArea.classList.remove('hidden');
        elements.nameSelect.value = '';
    }

    function showError(message) {
        elements.loadingArea.classList.add('hidden');
        elements.startArea.classList.add('hidden');
        elements.errorMessage.textContent = message;
        elements.errorArea.classList.remove('hidden');
    }

    // --- Event Listeners ---
    elements.startButton.addEventListener('click', startQuiz);
    elements.nextButton.addEventListener('click', () => {
        currentQuestionIndex++;
        if (currentQuestionIndex < quizData.length) {
            showQuestion();
        } else {
            showResults();
        }
    });
    elements.restartButton.addEventListener('click', restartQuiz);
    
    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', fetchData);
</script>
</body>
</html>

